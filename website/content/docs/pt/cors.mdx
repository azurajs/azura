---
title: CORS
description: Configure Cross-Origin Resource Sharing no AzuraJS
icon: Globe
---

# CORS üåê

Configure Cross-Origin Resource Sharing (CORS) para permitir que aplica√ß√µes frontend acessem sua API.

## Plugin CORS Embutido üì¶

AzuraJS inclui um plugin CORS pronto para uso:

```typescript
import { AzuraClient } from "azurajs";

const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: "*",  // Permitir todas as origens
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH"],
      allowedHeaders: ["Content-Type", "Authorization"],
      exposedHeaders: ["X-Total-Count"],
      credentials: true,
      maxAge: 86400  // 24 horas
    }
  }
});
```

## Configura√ß√£o do Plugin CORS ‚öôÔ∏è

### Op√ß√µes Dispon√≠veis

```typescript
interface CORSOptions {
  enabled: boolean;              // Ativar/desativar CORS
  origin: string | string[];     // Origens permitidas
  methods: string[];             // M√©todos HTTP permitidos
  allowedHeaders: string[];      // Cabe√ßalhos permitidos
  exposedHeaders?: string[];     // Cabe√ßalhos expostos ao cliente
  credentials?: boolean;         // Permitir cookies
  maxAge?: number;               // Cache de preflight (segundos)
  preflightContinue?: boolean;   // Passar preflight ao pr√≥ximo handler
}
```

### Exemplo Completo

```typescript
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: ["https://example.com", "https://app.example.com"],
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
      allowedHeaders: [
        "Content-Type",
        "Authorization",
        "X-Requested-With",
        "X-API-Key"
      ],
      exposedHeaders: [
        "X-Total-Count",
        "X-Page-Number",
        "X-Page-Size"
      ],
      credentials: true,
      maxAge: 7200  // 2 horas
    }
  }
});
```

## Origens Din√¢micas üéØ

Use uma fun√ß√£o para determinar origens dinamicamente:

```typescript
// Middleware CORS customizado
function corsMiddleware(req: RequestServer, res: ResponseServer, next: () => void) {
  const origin = req.headers.origin;
  
  // Lista de origens permitidas
  const allowedOrigins = [
    "https://example.com",
    "https://app.example.com",
    /^https:\/\/.*\.example\.com$/  // Subdom√≠nios
  ];
  
  // Verificar se origem √© permitida
  const isAllowed = allowedOrigins.some(allowed => {
    if (typeof allowed === "string") {
      return allowed === origin;
    }
    return allowed.test(origin || "");
  });
  
  if (isAllowed) {
    res.setHeader("Access-Control-Allow-Origin", origin!);
    res.setHeader("Access-Control-Allow-Credentials", "true");
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, PATCH");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  // Lidar com preflight
  if (req.method === "OPTIONS") {
    return res.status(204).end();
  }
  
  next();
}

app.use(corsMiddleware);
```

## Middleware CORS Simples üîå

Crie um middleware CORS b√°sico:

```typescript
function simpleCors(req: RequestServer, res: ResponseServer, next: () => void) {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  
  if (req.method === "OPTIONS") {
    return res.status(204).end();
  }
  
  next();
}

app.use(simpleCors);
```

## CORS com Credenciais üîê

Para permitir cookies e autentica√ß√£o:

```typescript
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: "https://app.example.com",  // Origem espec√≠fica (n√£o "*")
      credentials: true,  // Permitir cookies
      allowedHeaders: ["Content-Type", "Authorization"]
    }
  }
});
```

**Importante:** Quando `credentials: true`, `origin` N√ÉO pode ser `"*"`. Voc√™ deve especificar origens exatas.

## Preflight Requests ‚úàÔ∏è

Requisi√ß√µes preflight (OPTIONS) s√£o enviadas pelo navegador antes de requisi√ß√µes complexas:

```typescript
// Lidar com preflight manualmente
@Controller("/api")
export class ApiController {
  @Options("*")
  handlePreflight(@Res() res: ResponseServer) {
    res.setHeader("Access-Control-Allow-Origin", "https://example.com");
    res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
    res.setHeader("Access-Control-Max-Age", "86400");  // Cache por 24h
    res.status(204).end();
  }
}
```

## CORS por Rota üõ£Ô∏è

Aplique CORS a rotas espec√≠ficas:

```typescript
function corsForRoute(allowedOrigin: string) {
  return (req: RequestServer, res: ResponseServer, next: () => void) => {
    res.setHeader("Access-Control-Allow-Origin", allowedOrigin);
    res.setHeader("Access-Control-Allow-Methods", "GET, POST");
    
    if (req.method === "OPTIONS") {
      return res.status(204).end();
    }
    
    next();
  };
}

// Aplicar apenas a rotas p√∫blicas
app.use("/api/public", corsForRoute("*"));

// Aplicar apenas a rotas do painel
app.use("/api/dashboard", corsForRoute("https://dashboard.example.com"));
```

## Exemplos Pr√°ticos üé®

### API P√∫blica com CORS Aberto

```typescript
import { AzuraClient } from "azurajs";

const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: "*",
      methods: ["GET"],  // Apenas leitura
      allowedHeaders: ["Content-Type"]
    }
  }
});

@Controller("/api/public")
export class PublicApiController {
  @Get("/data")
  getData() {
    return { data: "p√∫blico" };
  }
}
```

### API Privada com CORS Restrito

```typescript
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: [
        "https://app.example.com",
        "https://admin.example.com"
      ],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization"],
      credentials: true
    }
  }
});

@Controller("/api/private")
export class PrivateApiController {
  @Get("/user")
  getUser(@Headers("authorization") auth: string) {
    // Verificar token
    return { user: "data" };
  }
}
```

### CORS Condicional

```typescript
function conditionalCors(req: RequestServer, res: ResponseServer, next: () => void) {
  const origin = req.headers.origin;
  const path = req.url;
  
  // Rotas p√∫blicas: CORS aberto
  if (path.startsWith("/api/public")) {
    res.setHeader("Access-Control-Allow-Origin", "*");
  }
  // Rotas privadas: CORS restrito
  else if (path.startsWith("/api/private")) {
    const allowedOrigins = ["https://app.example.com"];
    if (origin && allowedOrigins.includes(origin)) {
      res.setHeader("Access-Control-Allow-Origin", origin);
      res.setHeader("Access-Control-Allow-Credentials", "true");
    }
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (req.method === "OPTIONS") {
    return res.status(204).end();
  }
  
  next();
}

app.use(conditionalCors);
```

## Depura√ß√£o de CORS üîç

### Logging de CORS

```typescript
function corsDebug(req: RequestServer, res: ResponseServer, next: () => void) {
  const origin = req.headers.origin;
  const method = req.method;
  
  console.log("CORS Request:", { origin, method, path: req.url });
  
  res.setHeader("Access-Control-Allow-Origin", origin || "*");
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (method === "OPTIONS") {
    console.log("Preflight request handled");
    return res.status(204).end();
  }
  
  next();
}

app.use(corsDebug);
```

### Cabe√ßalhos de Resposta

Exponha cabe√ßalhos customizados ao frontend:

```typescript
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origin: "*",
      exposedHeaders: [
        "X-Total-Count",      // Total de registros
        "X-Page-Number",      // N√∫mero da p√°gina
        "X-Page-Size",        // Tamanho da p√°gina
        "X-RateLimit-Limit",  // Limite de rate
        "X-RateLimit-Remaining"  // Requisi√ß√µes restantes
      ]
    }
  }
});

@Get("/users")
getUsers(@Query("page") page: string, @Res() res: ResponseServer) {
  const users = getUsersFromDB(page);
  
  // Definir cabe√ßalhos customizados
  res.setHeader("X-Total-Count", "1000");
  res.setHeader("X-Page-Number", page || "1");
  res.setHeader("X-Page-Size", "10");
  
  res.json({ users });
}
```

## Problemas Comuns üö®

### Erro: Credenciais com Origin *

```typescript
// ‚ùå N√£o funciona
{
  origin: "*",
  credentials: true  // Erro!
}

// ‚úÖ Funciona
{
  origin: "https://app.example.com",
  credentials: true
}
```

### Cabe√ßalhos Customizados N√£o Funcionam

```typescript
// Frontend
fetch("https://api.example.com/data", {
  headers: {
    "X-Custom-Header": "value"  // Precisa estar em allowedHeaders
  }
});

// Backend
{
  cors: {
    allowedHeaders: [
      "Content-Type",
      "Authorization",
      "X-Custom-Header"  // Adicionar aqui
    ]
  }
}
```

### Preflight Cache

```typescript
{
  cors: {
    maxAge: 86400  // Cache preflight por 24h (reduz requisi√ß√µes OPTIONS)
  }
}
```

## Melhores Pr√°ticas ‚ú®

<Callout type="tip">
  **Seja espec√≠fico com origens**: Evite `"*"` em produ√ß√£o
</Callout>

<Callout type="tip">
  **Use HTTPS em produ√ß√£o**: CORS com credentials requer HTTPS
</Callout>

<Callout type="tip">
  **Cache preflight requests**: Use maxAge para reduzir requisi√ß√µes OPTIONS
</Callout>

<Callout type="warn">
  **N√£o exponha cabe√ßalhos sens√≠veis**: Apenas exponha o necess√°rio
</Callout>

## Pr√≥ximos Passos üìñ

<Cards>
  <Card title="Middleware" href="middleware" description="Crie middleware customizado" />
  <Card title="Rate Limiting" href="rate-limiting" description="Proteja sua API" />
  <Card title="Cookies" href="cookies" description="Use cookies com CORS" />
</Cards>
